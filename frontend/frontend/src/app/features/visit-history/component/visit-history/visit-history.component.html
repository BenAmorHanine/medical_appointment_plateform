<section class="container py-5">
  <h2 class="mb-4 text-center">
    <span class="gradient-text">Visit History</span>
  </h2>

  @if (loading()) {
    <div class="text-center">
      <div class="spinner-border text-primary"></div>
    </div>
  }

  @else if (error()) {
    <div class="alert alert-danger">
      {{ error() }}
    </div>
  }

  @else if (data()) {

    @if (data()!.blocked) {
      <div class="alert alert-danger text-center fw-bold">
        ⚠️ Patient account is blocked due to repeated absences
      </div>
    }

    <p class="text-muted text-center">
      Absences: {{ data()!.absenceCount }}
    </p>

    @if (data()!.history.length === 0) {
      <div class="alert alert-info text-center">
        No consultations found.
      </div>
    }

    @else {

      <!-- ================= TABLE ================= -->
      <table class="table table-hover shadow-sm">
        <thead class="table-light">
          <tr>
            <th>Date</th>
            <th>Type</th>
            <th>Status / Documents</th>
          </tr>
        </thead>

        <tbody>
          @for (item of data()!.history; track item.consultationId) {
            <tr>
              <td>{{ item.date | date:'dd/MM/yyyy HH:mm' }}</td>

              <td>{{ item.type | titlecase }}</td>

              <td>
                <span [class]="statusClass(item.status)">
                  {{ item.status }}
                </span>

                <div class="mt-2 d-flex gap-2">
                  @if (item.ordonnanceUrl) {
                    <a
                      class="btn btn-sm btn-outline-primary"
                      [href]="'http://localhost:3000' + item.ordonnanceUrl"
                      target="_blank"
                    >
                      Ordonnance
                    </a>
                  }

                  @if (item.certificatUrl) {
                    <a
                      class="btn btn-sm btn-outline-success"
                      [href]="'http://localhost:3000' + item.certificatUrl"
                      target="_blank"
                    >
                      Certificat
                    </a>
                  }
                </div>
              </td>
            </tr>
          }
        </tbody>
      </table>

      <!-- ================= TIMELINE ================= -->
      <h5 class="mt-5 mb-4 text-center">
        Visits <span class="gradient-text">Timeline</span>
      </h5>

      @if (presentVisits().length === 0) {
        <div class="alert alert-info text-center">
          No completed visits yet.
        </div>
      }

      @else {
        <div class="timeline">
          @for (item of presentVisits(); track item.consultationId) {
            <div class="timeline-item d-flex align-items-start mb-4">

              <div class="timeline-date me-4 fw-bold text-primary">
                {{ item.date | date:'dd MMM yyyy HH:mm' }}
              </div>

              <div class="timeline-dot me-3"></div>

              <div class="timeline-content">
                <strong class="text-capitalize">{{ item.type }}</strong>

                <div class="text-success small">
                  Consultation completed
                </div>

                <div class="mt-2 d-flex gap-2">
                  @if (item.ordonnanceUrl) {
                    <a
                      class="btn btn-sm btn-outline-primary"
                      [href]="'http://localhost:3000' + item.ordonnanceUrl"
                      target="_blank"
                    >
                      Ordonnance
                    </a>
                  }

                  @if (item.certificatUrl) {
                    <a
                      class="btn btn-sm btn-outline-success"
                      [href]="'http://localhost:3000' + item.certificatUrl"
                      target="_blank"
                    >
                      Certificat
                    </a>
                  }
                </div>
              </div>

            </div>
          }
        </div>
      }

    }
  }
</section>