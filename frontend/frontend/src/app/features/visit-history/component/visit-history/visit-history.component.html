<section class="visit-history-section">
  <div class="container py-5">
    <!-- Header Section -->
    <div class="history-header text-center mb-5">
      <h2 class="section-title mb-3">
        <span class="gradient-text">Visit History</span>
      </h2>
      <p class="section-subtitle">Track your medical consultations and documents</p>
    </div>

    @if (historyResource().loading) {
    <div class="loading-container text-center py-5">
      <div class="spinner-modern">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>
      <p class="mt-3 text-muted">Loading your visit history...</p>
    </div>
    }

    @else if (historyResource().error) {
    <div class="alert-modern alert-modern-danger">
      <i class="fas fa-exclamation-circle me-2"></i>
      <span>{{ historyResource().error }}</span>
    </div>
    }

    @else if (historyResource().data) {

    @if (historyResource().data!.blocked) {
    <div class="alert-modern alert-modern-warning">
      <i class="fas fa-exclamation-triangle me-2"></i>
      <span>Patient account is blocked due to repeated absences</span>
    </div>
    }
    <!--
    <p class="text-muted text-center">
      Absences: {{ data()!.absenceCount }}
    </p>-->

    @if (historyResource().data!.history.length === 0) {
    <div class="empty-state">
      <div class="empty-state-icon">
        <i class="fas fa-calendar-times"></i>
      </div>
      <h3 class="empty-state-title">No consultations found</h3>
      <p class="empty-state-text">You don't have any consultations yet.</p>
    </div>
    }

    @else {
    <!-- ================= TABLE SECTION ================= -->
    <div class="table-section">
      <div class="table-card">
        <div class="table-header">
          <h3 class="table-title">
            <i class="fas fa-list me-2"></i>
            Consultations List
          </h3>
        </div>
        <div class="table-responsive">
          <table class="table-modern">
            <thead>
              <tr>
                <th><i class="fas fa-calendar me-2"></i>Date</th>
                <th><i class="fas fa-stethoscope me-2"></i>Type</th>
                <th><i class="fas fa-info-circle me-2"></i>Status / Documents</th>
              </tr>
            </thead>
            <tbody>
              @for (item of historyResource().data!.history; track item.consultationId) {
              <tr>
                <td class="date-cell">
                  <i class="fas fa-clock me-2 text-muted"></i>
                  {{ item.date | date:'dd/MM/yyyy HH:mm' }}
                </td>
                <td class="type-cell">
                  <span class="type-badge">{{ item.type | titlecase }}</span>
                </td>
                <td>
                  <div class="status-documents">
                    <span class="badge-status badge-status-success">
                   <i class="fas fa-check-circle me-1"></i>
                            EFFECTUÃ‰E
                            </span>

                    <div class="mt-2 d-flex gap-2 flex-wrap">
                      @if (item.ordonnanceUrl) {
                      <button class="btn-document btn-document-primary" [appDownloadPdf]="item.ordonnanceUrl">
                        <i class="fas fa-file-prescription me-2"></i>
                        <span>Ordonnance</span>
                      </button>
                      }
                      @if (item.certificatUrl) {
                      <button class="btn-document btn-document-success" [appDownloadPdf]="item.certificatUrl">
                        <i class="fas fa-file-certificate me-2"></i>
                        <span>Certificat</span>
                      </button>
                      }
                    </div>
                  </div>
                </td>
              </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <!-- ================= PAGINATION ================= -->
    <div class="pagination-container d-flex justify-content-center align-items-center gap-3 mt-4">

      <button class="btn-pagination" (click)="prevPage()" [disabled]="page() === 1">
        <i class="fas fa-chevron-left me-2"></i>
        <span>Previous</span>
      </button>

      <span class="pagination-info fw-bold">
        Page {{ historyResource().data!.page }} / {{ historyResource().data!.totalPages }}
      </span>

      <button class="btn-pagination" (click)="nextPage()" [disabled]="page() === historyResource().data!.totalPages">
        <span>Next</span>
        <i class="fas fa-chevron-right ms-2"></i>
      </button>

    </div>


 <!-- ================= TIMELINE SECTION ================= -->
<div class="timeline-section mt-5">
  <div class="timeline-header text-center mb-5">
    <h3 class="section-title">
      Visits <span class="gradient-text">Timeline</span>
    </h3>
    <p class="section-subtitle">Completed consultations overview</p>
  </div>

  @if (historyResource().data!.history.length === 0) {
    <div class="empty-state">
      <div class="empty-state-icon">
        <i class="fas fa-check-circle"></i>
      </div>
      <h3 class="empty-state-title">No completed visits yet</h3>
      <p class="empty-state-text">
        Your completed consultations will appear here.
      </p>
    </div>
  }
  @else {
    <div class="timeline-container">
      @for (item of historyResource().data!.history; track item.consultationId) {
        <div class="timeline-item-modern">
          <div class="timeline-marker">
            <div class="timeline-dot-modern"></div>
            <div class="timeline-line"></div>
          </div>

          <div class="timeline-content-modern">
            <div class="timeline-date-modern">
              <i class="fas fa-calendar-alt me-2"></i>
              {{ item.date | date:'dd MMM yyyy HH:mm' }}
            </div>

            <div class="timeline-body">
              <h4 class="timeline-type">
                {{ item.type | titlecase }}
              </h4>

              <div class="timeline-status">
                <i class="fas fa-check-circle me-2 text-success"></i>
                <span>Consultation completed</span>
              </div>

              <div class="timeline-documents mt-3">
                @if (item.ordonnanceUrl) {
                  <button
                    class="btn-document btn-document-primary"
                    [appDownloadPdf]="item.ordonnanceUrl">
                    <i class="fas fa-file-prescription me-2"></i>
                    <span>Ordonnance</span>
                  </button>
                }

                @if (item.certificatUrl) {
                  <button
                    class="btn-document btn-document-success"
                    [appDownloadPdf]="item.certificatUrl">
                    <i class="fas fa-file-certificate me-2"></i>
                    <span>Certificat</span>
                  </button>
                }
              </div>
            </div>
          </div>
        </div>
      }
    </div>
  }
</div>
    }
  }
</div> <!-- container -->
</section>
